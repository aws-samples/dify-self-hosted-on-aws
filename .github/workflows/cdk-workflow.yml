# ===================================================================================
# GitHub Actions Workflow: Pull Request CDK Diffã€€ã‚’ä½œæˆ
# ï¼ˆå‚è€ƒï¼šapi-ai.git ã® cdk-workflow.yml ã‚’å‚è€ƒã«ï¼‰
#
# æ¦‚è¦:
#   Pull RequestãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸéš›ã«ã€å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ãŸç’°å¢ƒã«å¯¾ã—ã¦
#   CDK diffã‚’å®Ÿè¡Œã—ã€çµæœã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿ã™ã‚‹
#
# å‹•ä½œ:
#   - dev ãƒ–ãƒ©ãƒ³ãƒã¸ã®PR  â†’ dev ç’°å¢ƒã¨ã®å·®åˆ†ã‚’è¡¨ç¤º
#   - main ãƒ–ãƒ©ãƒ³ãƒã¸ã®PR â†’ main ç’°å¢ƒã¨ã®å·®åˆ†ã‚’è¡¨ç¤º
# ===================================================================================

name: CDK Diff on Pull Request

on:
  pull_request:
    branches:
      - dev
      - main
    types:
      - opened
      - synchronize

jobs:
  cdk-diff:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'

    # PRã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦ç’°å¢ƒã‚’é¸æŠ
    environment: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.0'

      - name: Install dependencies
        run: |
          npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: CDK Diff
        id: cdk-diff
        run: |
          export CDK_DEFAULT_ACCOUNT=${{ secrets.AWS_ACCOUNT_ID }}
          export CDK_DEFAULT_REGION=us-west-2
          export ALLOWED_IPV4_CIDRS="${{ secrets.ALLOWED_IPV4_CIDRS }}"
          export ALLOWED_COUNTRY_CODES="${{ secrets.ALLOWED_COUNTRY_CODES }}"

          # CDK diffã‚’å®Ÿè¡Œã—ã€çµæœã‚’å–å¾—ï¼ˆãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³å¯¾å¿œï¼‰
          diff=$(npx cdk diff --all 2>&1) || true
          echo "$diff"

          # GitHubã®å‡ºåŠ›å¤‰æ•°ã«ä¿å­˜ï¼ˆBase64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
          echo "cdk_diff=$(echo "$diff" | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦CDK diffå‡ºåŠ›ã‚’å–å¾—
            const base64Diff = '${{ steps.cdk-diff.outputs.cdk_diff }}';
            const diff = base64Diff ? Buffer.from(base64Diff, 'base64').toString('utf-8') : '';

            const body = diff ? `## ğŸ“‹ CDK Diff Results
                        
            <details>
            <summary>Click to expand diff results</summary>

            \`\`\`
            ${diff}
            \`\`\`

            </details>

            ---
            âš ï¸ Please review the changes above before merging.` : "## ğŸ“‹ CDK Diff Results\n\nNo infrastructure changes detected.";

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('CDK Diff Results')
            );

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
